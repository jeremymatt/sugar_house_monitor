<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Matt's Maple Syrup - Sugar House Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #101318;
      --card-bg: #181d24;
      --card-border: #262c36;
      --accent: #f2a93b;
      --accent-soft: rgba(242, 169, 59, 0.15);
      --text-main: #f5f5f5;
      --text-muted: #a7afbf;
      --danger: #ff5f5f;
      --danger-soft: rgba(255, 95, 95, 0.15);
      --warn: #f2d15c;
      --ok: #4caf50;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d2430 0, #101318 50%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 1100px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .title-group h1 {
      font-size: 1.6rem;
      letter-spacing: 0.04em;
    }

    .title-group span {
      display: block;
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }

    .status-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .pill {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      background: rgba(0, 0, 0, 0.25);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .pill-dot {
      width: 0.45rem;
      height: 0.45rem;
      border-radius: 999px;
      background: var(--ok);
    }

    .pill-dot.stale {
      background: var(--danger);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
      gap: 1.25rem;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--card-border);
      padding: 1rem 1.1rem;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.6);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .card-header h2 {
      font-size: 1.1rem;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .warning-tag {
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      border: 1px solid var(--danger);
      background: var(--danger-soft);
      color: var(--danger);
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem;
      margin-top: 0.75rem;
    }

    .overview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .metric {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      font-size: 0.85rem;
    }

    .metric-label {
      color: var(--text-muted);
    }

    .metric-value {
      font-size: 1.1rem;
    }

    .metric-note {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .chart-container {
      margin: 0.5rem 0 1rem;
      padding: 0.5rem;
      border: 1px solid var(--card-border);
      border-radius: 12px;
      background: rgba(0,0,0,0.15);
      width: 100%;
    }

    .chart-legend {
      display: flex;
      gap: 1rem;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .legend-swatch {
      width: 12px;
      height: 12px;
      border-radius: 4px;
      display: inline-block;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.35rem 0.65rem;
      border-radius: 999px;
      font-size: 0.85rem;
      border: 1px solid var(--card-border);
      background: rgba(0,0,0,0.25);
    }
    .status-good {
      color: var(--ok);
    }
    .status-bad {
      color: var(--danger);
      border-color: var(--danger);
      background: var(--danger-soft);
    }

    .tank-level-bar {
      position: relative;
      height: 140px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      overflow: hidden;
      background: radial-gradient(circle at top, #222b3a, #10141c 70%);
      margin-top: 0.75rem;
    }

    .tank-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(242,169,59,0.9), rgba(242,169,59,0.1));
      transition: height 0.5s ease-out;
    }

    .tank-fill-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background-image: linear-gradient(
        to top,
        rgba(0,0,0,0.25),
        transparent 30%,
        transparent 70%,
        rgba(255,255,255,0.05)
      );
      mix-blend-mode: soft-light;
    }

    .tank-level-labels {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 0.4rem 0.5rem;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .storage-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 1.25rem;
    }

    .storage-item {
      text-align: center;
    }

    .storage-bar {
      position: relative;
      height: 140px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      overflow: hidden;
      background: radial-gradient(circle at top, #222b3a, #10141c 70%);
      margin-top: 0.75rem;
    }

    .storage-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      transition: height 0.5s ease-out;
    }

    .storage-fill.storage-ok {
      background: linear-gradient(to top, rgba(76,175,80,0.9), rgba(76,175,80,0.15));
    }

    .storage-fill.storage-warn {
      background: linear-gradient(to top, rgba(242,209,92,0.9), rgba(242,209,92,0.15));
    }

    .storage-fill.storage-bad {
      background: linear-gradient(to top, rgba(255,95,95,0.9), rgba(255,95,95,0.15));
    }

    .storage-bar-label {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      color: var(--text-main);
      text-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    .storage-values {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .storage-value {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
      text-align: left;
    }

    .last-updated {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }

    .error-banner {
      margin-top: 0.75rem;
      padding: 0.5rem 0.7rem;
      border-radius: 10px;
      border: 1px dashed var(--danger);
      background: var(--danger-soft);
      font-size: 0.8rem;
      color: var(--danger);
    }

    .small {
      font-size: 0.75rem;
    }

    a {
      color: var(--accent);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .boiling-grid {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    @media (max-width: 900px) {
      .boiling-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
      .storage-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title-group">
        <h1>Sugar House Monitor</h1>
        <span>Matt's Maple Syrup &mdash; live tank and pump status</span>
      </div>
      <div class="status-bar">
        <div id="global-status-pill" class="pill">
          <span class="pill-dot" id="global-status-dot"></span>
          <span id="global-status-text">Loading latest data&hellip;</span>
        </div>
        <span id="generated-at" class="small"></span>
      </div>
    </header>

    <section class="card" id="overview-card">
      <div class="card-header">
        <div>
          <h2>System Overview</h2>
          <div class="card-subtitle">Combined tanks (flows only), vacuum, and stack temps</div>
        </div>
      </div>

      <div class="overview-grid">
        <div class="metric">
          <span class="metric-label">Vacuum</span>
          <span class="metric-value" id="vacuum-reading">–</span>
          <span class="metric-note" id="vacuum-reading-note">Awaiting data</span>
        </div>
        <div class="metric">
          <span class="metric-label">Total sap</span>
          <span class="metric-value" id="overview-total-gallons">–</span>
          <span class="metric-note">Brookside + Roadside</span>
        </div>
        <div class="metric">
          <span class="metric-label">Net flow</span>
          <span class="metric-value" id="overview-net-flow">–</span>
          <span class="metric-note">Tank flows only (pump ignored)</span>
        </div>
        <div class="metric">
          <span class="metric-label">Overflow in</span>
          <span class="metric-value" id="overview-overflow-time">---</span>
          <span class="metric-note" id="overview-overflow-eta">---</span>
        </div>
        <div class="metric">
          <span class="metric-label">Stack temp</span>
          <span class="metric-value" id="stack-temp-value">–</span>
          <span class="metric-note" id="stack-temp-note">Awaiting data</span>
        </div>
        <div class="metric">
          <span class="metric-label">Ambient temp</span>
          <span class="metric-value" id="ambient-temp-value">–</span>
          <span class="metric-note" id="ambient-temp-note">Awaiting data</span>
        </div>
        <div class="metric">
          <span class="metric-label">Tank Monitor</span>
          <span class="metric-value" id="monitor-tank-status">–</span>
          <span class="metric-note" id="monitor-tank-note">Awaiting heartbeat</span>
        </div>
        <div class="metric">
          <span class="metric-label">Pump Monitor</span>
          <span class="metric-value" id="monitor-pump-status">–</span>
          <span class="metric-note" id="monitor-pump-note">Awaiting heartbeat</span>
        </div>
      </div>
    </section>

    

    <!-- Boiling status -->
    <section class="card" id="boiling-card">
      <div class="card-header" style="align-items:flex-start; gap:0.5rem; flex-wrap:wrap;">
        <div>
          <h2>Boiling Status</h2>
          <div class="card-subtitle">Evaporator flow and draw/pump sources</div>
        </div>
        <div style="display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap;">
          <label for="boiling-history-window" class="metric-note" style="white-space:nowrap;">Window</label>
          <select id="boiling-history-window" class="metric-note" style="background:rgba(0,0,0,0.25); color:var(--text-main); border:1px solid var(--card-border); border-radius:8px; padding:0.2rem 0.35rem;">
            <option value="3600">1h</option>
            <option value="7200" selected>2h</option>
            <option value="14400">4h</option>
            <option value="21600">6h</option>
            <option value="28800">8h</option>
            <option value="43200">12h</option>
          </select>
          <label for="boiling-y-min" class="metric-note" style="white-space:nowrap;">Y-min</label>
          <select id="boiling-y-min" class="metric-note" style="background:rgba(0,0,0,0.25); color:var(--text-main); border:1px solid var(--card-border); border-radius:8px; padding:0.2rem 0.35rem;">
            <option value="0">0</option>
            <option value="100">100</option>
            <option value="200" selected>200</option>
            <option value="300">300</option>
            <option value="400">400</option>
            <option value="500">500</option>
          </select>
          <label for="boiling-y-max" class="metric-note" style="white-space:nowrap;">Y-max</label>
          <select id="boiling-y-max" class="metric-note" style="background:rgba(0,0,0,0.25); color:var(--text-main); border:1px solid var(--card-border); border-radius:8px; padding:0.2rem 0.35rem;">
            <option value="300">300</option>
            <option value="400">400</option>
            <option value="500">500</option>
            <option value="600" selected>600</option>
            <option value="700">700</option>
            <option value="800">800</option>
          </select>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-legend">
          <span class="legend-item"><span class="legend-swatch" style="background:#7a7f8a;"></span>Draw Off: ---</span>
          <span class="legend-item"><span class="legend-swatch" style="background:#0072b2;"></span>Draw Off: Brookside</span>
          <span class="legend-item"><span class="legend-swatch" style="background:#d55e00;"></span>Draw Off: Roadside</span>
          <span class="legend-item"><span class="legend-swatch" style="background:transparent; border:2px dashed #cfd2d9;"></span>Stack temp</span>
        </div>
        <canvas id="boiling-history-canvas" width="600" height="220" aria-label="Evaporator flow history" style="width:100%; height:240px;"></canvas>
        <div class="metric-note" id="boiling-history-note">Showing last 2 hours</div>
      </div>

      <div class="grid boiling-grid">
        <div class="metric">
          <span class="metric-label">Evaporator Flow</span>
          <span class="metric-value" id="boiling-evap-flow">–</span>
          <span class="metric-note" id="boiling-evap-ts">Time: –</span>
        </div>
        <div class="metric">
          <span class="metric-label">Last fire in</span>
          <span class="metric-value" id="boiling-last-fire-time">---</span>
          <span class="metric-note" id="boiling-last-fire-eta">---</span>
        </div>
        <div class="metric">
          <span class="metric-label">Draw Off</span>
          <span class="metric-value" id="boiling-draw-off">---</span>
          <span class="metric-note" id="boiling-draw-off-flow">Flow: –</span>
        </div>
        <div class="metric">
          <span class="metric-label">Pump In</span>
          <span class="metric-value" id="boiling-pump-in">---</span>
          <span class="metric-note" id="boiling-pump-in-flow">Flow: –</span>
        </div>
      </div>
    </section>

    <!-- Stack sections full width -->
    <section class="card" id="pump-card">
      <div class="card-header" style="align-items:flex-start; gap:0.5rem;">
        <div>
          <h2>Transfer Pump</h2>
          <div class="card-subtitle">Last pump cycle and estimated flow into sugar house</div>
        </div>
        <div style="display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap;">
          <label for="pump-history-window" class="metric-note" style="white-space:nowrap;">Window</label>
          <select id="pump-history-window" class="metric-note" style="background:rgba(0,0,0,0.25); color:var(--text-main); border:1px solid var(--card-border); border-radius:8px; padding:0.2rem 0.35rem;">
            <option value="10800">3h</option>
            <option value="21600" selected>6h</option>
            <option value="43200">12h</option>
            <option value="86400">24h</option>
            <option value="259200">3d</option>
            <option value="604800">7d</option>
            <option value="1209600">14d</option>
          </select>
          <label for="pump-y-min" class="metric-note" style="white-space:nowrap;">Y-min</label>
          <select id="pump-y-min" class="metric-note" style="background:rgba(0,0,0,0.25); color:var(--text-main); border:1px solid var(--card-border); border-radius:8px; padding:0.2rem 0.35rem;">
            <option value="0" selected>0</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="150">150</option>
            <option value="200">200</option>
            <option value="250">250</option>
          </select>
          <label for="pump-y-max" class="metric-note" style="white-space:nowrap;">Y-max</label>
          <select id="pump-y-max" class="metric-note" style="background:rgba(0,0,0,0.25); color:var(--text-main); border:1px solid var(--card-border); border-radius:8px; padding:0.2rem 0.35rem;">
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="150">150</option>
            <option value="200" selected>200</option>
            <option value="300">300</option>
            <option value="500">500</option>
          </select>
          <div id="pump-warning" class="warning-tag" style="display:none;">
            ⚠ Pump data stale
          </div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-legend">
          <span class="legend-item"><span class="legend-swatch" style="background:#d55e00;"></span>Pump</span>
          <span class="legend-item"><span class="legend-swatch" style="background:#0072b2;"></span>Tank inflow</span>
          <span class="legend-item"><span class="legend-swatch" style="background:transparent; border:2px dashed #cfd2d9;"></span>Vacuum</span>
        </div>
        <canvas id="pump-history-canvas" width="600" height="220" aria-label="Pump flow history" style="width:100%; height:240px;"></canvas>
        <div class="metric-note" id="pump-history-note">Showing last 6 hours</div>
      </div>

      <div class="grid">
        <div class="metric">
          <span class="metric-label">Pump Status</span>
          <span class="metric-value" id="pump-event-type">–</span>
          <span class="metric-note" id="pump-last-time">Time: –</span>
        </div>
        <div class="metric">
          <span class="metric-label">Estimated flow</span>
          <span class="metric-value" id="pump-flow">–</span>
          <span class="metric-note" id="pump-run-summary">Run time / interval: –</span>
        </div>
      </div>

      <div id="pump-error" class="error-banner" style="display:none;">
        Pump event data unavailable. This is expected if the pump only runs occasionally,
        but check wiring / Pi if this remains for an extended period.
      </div>
    </section>

    <!-- Tanks card -->
    <section class="card" id="tanks-card">
      <div class="card-header">
        <div>
          <h2>Holding Tanks</h2>
          <div class="card-subtitle">Brookside &amp; Roadside volumes and flow</div>
        </div>
        <div id="tanks-warning" class="warning-tag" style="display:none;">
          ⚠ Tank readings stale
        </div>
      </div>

      <div class="grid">
        <div>
          <h3 class="small">Brookside Tank</h3>
          <div class="tank-level-bar">
            <div class="tank-fill" id="brookside-fill" style="height:0%;"></div>
            <div class="tank-fill-overlay"></div>
            <div class="tank-level-labels">
              <span>100%</span>
              <span>75%</span>
              <span>50%</span>
              <span>25%</span>
              <span>0%</span>
            </div>
          </div>
          <div class="grid">
            <div class="metric">
              <span class="metric-label">Volume</span>
              <span class="metric-value" id="brookside-volume">–</span>
              <span class="metric-note" id="brookside-capacity">Capacity: –</span>
            </div>
            <div class="metric">
              <span class="metric-label">Flow</span>
              <span class="metric-value" id="brookside-flow">–</span>
              <span class="metric-note" id="brookside-eta">ETA full/empty: –</span>
            </div>
          </div>
        </div>

        <div>
          <h3 class="small">Roadside Tank</h3>
          <div class="tank-level-bar">
            <div class="tank-fill" id="roadside-fill" style="height:0%;"></div>
            <div class="tank-fill-overlay"></div>
            <div class="tank-level-labels">
              <span>100%</span>
              <span>75%</span>
              <span>50%</span>
              <span>25%</span>
              <span>0%</span>
            </div>
          </div>
          <div class="grid">
            <div class="metric">
              <span class="metric-label">Volume</span>
              <span class="metric-value" id="roadside-volume">–</span>
              <span class="metric-note" id="roadside-capacity">Capacity: –</span>
            </div>
            <div class="metric">
              <span class="metric-label">Flow</span>
              <span class="metric-value" id="roadside-flow">–</span>
              <span class="metric-note" id="roadside-eta">ETA full/empty: –</span>
            </div>
          </div>
        </div>
      </div>

      <div id="tanks-error" class="error-banner" style="display:none;">
        Unable to load tank data. Check network or Pi/server status.
      </div>
    </section>

    <section class="card" id="storage-card">
      <div class="card-header">
        <div>
          <h2>Storage Utilization</h2>
          <div class="card-subtitle">Tank Pi, Pump Pi, and server disk usage</div>
        </div>
      </div>

      <div class="storage-grid">
        <div class="storage-item">
          <h3 class="small">Tank Pi</h3>
          <div class="storage-bar">
            <div class="storage-fill" id="storage-tank-fill" style="height:0%;"></div>
            <div class="storage-bar-label" id="storage-tank-percent">--%</div>
          </div>
          <div class="storage-values">
            <div class="storage-value">
              <span>Used</span>
              <span id="storage-tank-used">--</span>
            </div>
            <div class="storage-value">
              <span>Avail</span>
              <span id="storage-tank-avail">--</span>
            </div>
          </div>
        </div>

        <div class="storage-item">
          <h3 class="small">Pump Pi</h3>
          <div class="storage-bar">
            <div class="storage-fill" id="storage-pump-fill" style="height:0%;"></div>
            <div class="storage-bar-label" id="storage-pump-percent">--%</div>
          </div>
          <div class="storage-values">
            <div class="storage-value">
              <span>Used</span>
              <span id="storage-pump-used">--</span>
            </div>
            <div class="storage-value">
              <span>Avail</span>
              <span id="storage-pump-avail">--</span>
            </div>
          </div>
        </div>

        <div class="storage-item">
          <h3 class="small">Server</h3>
          <div class="storage-bar">
            <div class="storage-fill" id="storage-server-fill" style="height:0%;"></div>
            <div class="storage-bar-label" id="storage-server-percent">--%</div>
          </div>
          <div class="storage-values">
            <div class="storage-value">
              <span>Used</span>
              <span id="storage-server-used">--</span>
            </div>
            <div class="storage-value">
              <span>Avail</span>
              <span id="storage-server-avail">--</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div style="text-align:right; margin-top:-0.25rem;">
      <a href="/sugar_house_monitor/downloads.html">Download CSV data</a>
      <span style="margin: 0 0.4rem; color: var(--text-muted);">|</span>
      <a href="/sugar_house_monitor/tank_error_log.txt">Tank error log</a>
      <span style="margin: 0 0.4rem; color: var(--text-muted);">|</span>
      <a href="/sugar_house_monitor/pump_error_log.txt">Pump error log</a>
      <span style="margin: 0 0.4rem; color: var(--text-muted);">|</span>
      <a href="/sugar_house_monitor/vacuum/">Simple vacuum</a>
    </div>

    <footer class="small" style="margin-top:0.5rem; color:var(--text-muted);">
      Data provided by Raspberry Pi monitors. This page reads a JSON status file and
      computes freshness client-side. For debugging or data export, use the Pi / server tools.
    </footer>
  </div>

  <script src="/sugar_house_monitor/js/app.js"></script>
</body>
</html>
